<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Explore {{ datasource.name }} - ABC Data Analytics</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { margin: 0; }
        .back { color: #007bff; text-decoration: none; }
        .back:hover { text-decoration: underline; }
        .section { background: white; padding: 20px; margin: 20px 0; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .table-card { background: #f9f9f9; padding: 15px; margin: 15px 0; border-left: 4px solid #28a745; border-radius: 3px; }
        .table-name { font-size: 18px; font-weight: bold; color: #333; margin: 0 0 10px 0; cursor: pointer; }
        .table-name:hover { color: #007bff; }
        .columns-list { display: none; background: white; padding: 10px; border-radius: 3px; margin-top: 10px; }
        .columns-list.expanded { display: block; }
        .column-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .column-item:last-child { border-bottom: none; }
        .column-name { font-weight: bold; color: #333; }
        .column-type { color: #666; font-size: 12px; font-family: monospace; }
        .column-nullable { color: #999; font-size: 12px; margin-left: 10px; }
        .btn { padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; text-decoration: none; display: inline-block; }
        .btn:hover { background: #0056b3; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-preview { background: #28a745; }
        .btn-preview:hover { background: #218838; }
        .error { color: red; padding: 15px; background: #f8d7da; border-radius: 3px; margin: 10px 0; }
        .empty { color: #999; text-align: center; padding: 20px; }
        .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .preview-modal.show { display: flex; }
        .preview-content { background: white; padding: 20px; border-radius: 5px; max-width: 90%; max-height: 90%; overflow: auto; }
        .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .preview-header h3 { margin: 0; }
        .preview-close { background: #dc3545; color: white; border: none; cursor: pointer; padding: 8px 15px; border-radius: 3px; }
        .preview-table { width: 100%; border-collapse: collapse; }
        .preview-table th { background: #007bff; color: white; padding: 10px; text-align: left; }
        .preview-table td { padding: 10px; border-bottom: 1px solid #ddd; }
        .preview-table tr:hover { background: #f5f5f5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Explore: {{ datasource.name }}</h1>
            <a href="{% url 'org_detail' datasource.organization.id %}" class="back">‚Üê Back to Data Sources</a>
        </div>

        <div class="section">
            <h3>Data Source Details</h3>
            <p><strong>Name:</strong> {{ datasource.name }}</p>
            <p><strong>Type:</strong> {{ datasource.get_source_type_display }}</p>
            <p><strong>Created:</strong> {{ datasource.created_at|date:"M d, Y H:i" }}</p>
        </div>

        {% if error %}
            <div class="error">
                <strong>Error:</strong> {{ error }}
            </div>
        {% endif %}

        <div class="section">
            <h3>Tables ({{ tables|length }})</h3>
            
            {% if tables %}
                {% for table in tables %}
                    <div class="table-card">
                        <div class="table-name" onclick="toggleColumns(this)">
                            üìä {{ table.name }} ({{ table.columns|length }} columns)
                        </div>
                        <div class="columns-list">
                            <div style="margin-bottom: 10px;">
                                <button class="btn btn-sm btn-preview" onclick="previewTable('{{ table.name }}', {{ datasource.id }})">
                                    Preview Data
                                </button>
                            </div>
                            {% for column in table.columns %}
                                <div class="column-item">
                                    <div>
                                        <span class="column-name">{{ column.name }}</span>
                                        <span class="column-nullable">
                                            {% if column.nullable %}(nullable){% else %}(required){% endif %}
                                        </span>
                                    </div>
                                    <span class="column-type">{{ column.type }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty">No tables found in this database.</div>
            {% endif %}
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-content">
            <div class="preview-header">
                <h3 id="previewTitle">Table Data</h3>
                <button class="preview-close" onclick="closePreview()">Close</button>
            </div>
            <div id="previewBody" style="overflow-x: auto;"></div>
        </div>
    </div>

    <script>
        function toggleColumns(element) {
            const columnsList = element.nextElementSibling;
            columnsList.classList.toggle('expanded');
        }

        function previewTable(tableName, datasourceId) {
            fetch(`/datasource/${datasourceId}/preview/${tableName}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('previewTitle').textContent = `Preview: ${tableName}`;
                        
                        if (data.rows.length === 0) {
                            document.getElementById('previewBody').innerHTML = '<p>No data in this table.</p>';
                        } else {
                            let html = '<table class="preview-table"><thead><tr>';
                            data.columns.forEach(col => {
                                html += `<th>${col}</th>`;
                            });
                            html += '</tr></thead><tbody>';
                            
                            data.rows.forEach(row => {
                                html += '<tr>';
                                data.columns.forEach(col => {
                                    const value = row[col] !== null ? row[col] : '<em>NULL</em>';
                                    html += `<td>${value}</td>`;
                                });
                                html += '</tr>';
                            });
                            
                            html += '</tbody></table>';
                            document.getElementById('previewBody').innerHTML = html;
                        }
                        
                        document.getElementById('previewModal').classList.add('show');
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error loading preview: ' + error);
                });
        }

        function closePreview() {
            document.getElementById('previewModal').classList.remove('show');
        }

        // Close modal on background click
        document.getElementById('previewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('show');
            }
        });
    </script>
</body>
</html>
